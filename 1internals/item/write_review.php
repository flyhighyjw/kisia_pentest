<?php
session_start();
require_once $_SERVER['DOCUMENT_ROOT'].'/3severside/database.php';
error_reporting(E_ALL);
ini_set('display_errors', 1);

$message = isset($_GET['message']) ? $_GET['message'] : '';

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['dno'], $_POST['rtitle'], $_POST['rcont'])) {
    $dno = $_POST['dno'];
    $rtitle = trim($_POST['rtitle']);
    $rcont = trim($_POST['rcont']);
    
    // Assuming you have a column named 'rimg' in your Reviews table to store the file path
    $rimg = ''; // Initialize the file path variable
    
    // Check if file is uploaded
    if (isset($_FILES['rimg']) && $_FILES['rimg']['error'] === UPLOAD_ERR_OK) {
        $uploadDir = $_SERVER['DOCUMENT_ROOT'] . '/2assets/review/';
        $fileName = basename($_FILES['rimg']['name']);
        $uploadFile = $uploadDir . $fileName;
        if (move_uploaded_file($_FILES['rimg']['tmp_name'], $uploadFile)) {
            $rimg = $fileName; // Save only the file name
        } else {
            $message = "Error: File upload failed. Error code: " . $_FILES['rimg']['error'];
            echo $message;
            exit();
        }
    }else {
        $message = "Error: File upload failed. Error code: " . $_FILES['rimg']['error'];
        echo $message;
        exit();
    }


    // Fetch the uno from the database using uid from $_SESSION['userid']
    $userId = $_SESSION['userid'];
    $userQuery = "SELECT uno FROM Users WHERE uid = '$userId'";
    $userResult = execute_query($userQuery);
    if ($userResult->num_rows > 0) {
        $userRow = $userResult->fetch_assoc();
        $uno = $userRow['uno'];
        
        // Insert review into the Reviews table
        $insertQuery = "INSERT INTO Reviews (dno, rtitle, rcont, rimg, uno) VALUES ($dno, '$rtitle', '$rcont', '$rimg', $uno)";
        if (execute_query($insertQuery)) {
            header("Location: show_descr.php?dno=$dno&message=Review+added+successfully");
            exit;
        } else {
            $message = "Error: Could not add review. Please try again.";
        }
    } else {
        $message = "Error: User not found.";
    }
}

?>

<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Write a Review</title>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #F5F5F5; color: #333; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .container { width: 70%; padding: 20px; background-color: #fff; border-radius: 10px; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.3); text-align: center; }
        h1 { color: #005691; text-align: center; margin-bottom: 20px; }
        form { display: flex; flex-direction: column; align-items: center; }
        label { font-weight: bold; margin-bottom: 10px; color: #333; text-align: left; width: 100%; }
        input[type="text"], textarea { padding: 10px; margin-bottom: 20px; border-radius: 5px; border: 1px solid #ccc; transition: border-color 0.3s ease; font-size: 16px; width: 100%; max-width: 70%; width: 700px; height: 100px; }
        input[type="text"]:focus, textarea:focus { outline: none; border-color: #005691; }
        button[type="submit"] { padding: 12px 20px; border: none; border-radius: 5px; background-color: #005691; color: #fff; font-size: 18px; cursor: pointer; transition: background-color 0.3s ease; width: 100%; max-width: 70%; }
        button[type="submit"]:hover { background-color: #0E2D5C; }
    </style>
</head>
<body>
    
    <?php if ($message) { ?>
        <p><?php echo htmlspecialchars($message) ?></p>
    <?php } ?>
    <form action="write_review.php" method="POST" enctype="multipart/form-data">
        <h1>Write a Review</h1></br>
        <input type="hidden" name="dno" value="<?php echo htmlspecialchars($_GET['dno']); ?>">
        <label for="rtitle">Title:</label><br>
        <input type="text" id="rtitle" name="rtitle" required><br>
        <label for="rcont">Content:</label><br>
        <textarea id="rcont" name="rcont" required></textarea><br>
        <label for="rimg">Upload Image:</label><br>
        <input type="file" id="rimg" name="rimg"><br>
        <button type="submit">Submit Review</button>
    </form>
</body>
</html>
