<?php
require_once $_SERVER['DOCUMENT_ROOT'] . '/3severside/database.php';
session_start();

// Show me the money i mean error
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

$dno = isset($_GET['dno']) ? $_GET['dno'] : '';
//echo "dno: $dno<br>";

// Check session user type and redirect accordingly
if (!isset($_GET['dno'])) {
    //echo "dno is not set. Redirecting to /errrrror.html<br>";
    header('Location: /error.html');
    exit();
} elseif (!isset($_SESSION['usertype'])) {
    //echo "Session 'usertype' is not set. Redirecting to signin page.<br>";
    header("Location: /1internals/signin.php?lastpage=buy&itemno=$dno");
    exit();
} elseif ($_SESSION['usertype'] == 'Employee') {
    //echo "Session usertype is 'Employee'. Redirecting to /errrrror.html<br>";
    header('Location: /errrrror.html');
    exit();
} elseif ($_SESSION['usertype'] == 'Customer') {
    //echo "Session usertype is 'Customer'. Proceeding to show category items.<br>";
    show_category_items($dno);
} else {
    //echo "Session usertype is neither 'Employee' nor 'Customer'. Redirecting to signin page.<br>";
    header("Location: /1internals/signin.php?lastpage=buy&itemno=$dno");
    exit();
}

function show_category_items($dno) {
    //echo "Inside show_category_items function. dno: $dno<br>";
    $userid = $_SESSION["userid"];
    //echo "userid from session: $userid<br>";
    
    $query = "SELECT uno FROM Users WHERE uid = '$userid'";
    //echo "Executing query: $query<br>";
    $result = execute_query($query);

    if (!$result) {
        //echo "Query failed: " . execute_query_error() . "<br>";
        exit();
    }

    if ($result->num_rows <= 0) {
        //echo "User not found based on the session. WHAT DID YOU DO<br>";
        exit();
    }

    $row = $result->fetch_assoc();
    $uno = $row['uno'];
    //echo "uno from Users table: $uno<br>";

    $query = "SELECT * FROM Carts WHERE uno = $uno AND dno = '$dno'";
    //echo "Executing query: $query<br>";
    $result = execute_query($query);

    if ($result && $result->num_rows > 0) { // means already in cart
        //echo "Item already in cart. Updating cart.<br>";
        $sql = "UPDATE Carts SET camo = camo + 1 WHERE uno = $uno AND dno = '$dno'";
    } else {
        //echo "Item not in cart. Inserting new item.<br>";
        $sql = "INSERT INTO Carts (uno, camo, dno) VALUES ('$uno', 1, '$dno')";
    }
    
    //echo "Executing query: $sql<br>";
    $result = execute_query($sql);
    /*
    if (!$result) {
        echo "Query failed: " . execute_query_error() . "<br>";
    } else {
        echo "Query executed successfully.<br>";
    }
    */

    header("Location: show_descr.php?dno=$dno&message=Item%20is%20added%20to%20your%20cart.");
}
?>
