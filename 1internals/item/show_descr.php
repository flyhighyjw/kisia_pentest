<?php
session_start(); 
require_once $_SERVER['DOCUMENT_ROOT'].'/3severside/database.php';
error_reporting(E_ALL);
ini_set('display_errors', 1);

$message = isset($_GET['message']) ? $_GET['message'] : '';

if (isset($_GET['dno'])) {
    $dno = $_GET['dno'];
    $query = "SELECT D.dno, D.dtitle, D.dimg, D.dcont, I.iprice, I.istat, I.ino
              FROM Descriptions AS D 
              INNER JOIN Items AS I ON D.ino = I.ino 
              WHERE D.dno = $dno";
    $result = execute_query($query);
    if ($result->num_rows > 0) {
        $row = $result->fetch_assoc();
        $isAvailableForSale = $row['istat'];
    } else {
        $row = null;
        $isAvailableForSale = false;
    }
    $qnaResult = execute_query("SELECT * FROM Qnas WHERE dno = $dno");
    $reviewResult = execute_query("SELECT * FROM Reviews WHERE dno = $dno");
} else { 
    header("Location: /error.html");
    exit; 
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['qno'], $_POST['qreply'])) {
    $qno = $_POST['qno'];
    $qreply = trim($_POST['qreply']);
    $enoResult = execute_query("SELECT eno FROM Employees WHERE eid = '{$_SESSION['userid']}'");
    if ($enoResult->num_rows <= 0) {
        header("Location: /error.html");
        exit;
    }
    $row = $enoResult->fetch_assoc();
    $eno = $row['eno'];

    $updateQuery = "UPDATE Qnas SET qreply = '$qreply', eno = $eno WHERE qno = $qno";
    if (execute_query($updateQuery)) {
        header("Location: show_descr.php?dno=$dno&message=Reply+added+successfully");
        exit;
    } else {
        $message = "Error: Could not update the reply. Please try again.";
    }
}
elseif ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['rno'], $_POST['rreply'])) {
    $rno = $_POST['rno'];
    $rreply = trim($_POST['rreply']);
    $enoResult = execute_query("SELECT eno FROM Employees WHERE eid = '{$_SESSION['userid']}'");
    if ($enoResult->num_rows <= 0) {
        header("Location: /error.html");
        exit;
    }
    $row = $enoResult->fetch_assoc();
    $eno = $row['eno'];

    $updateQuery = "UPDATE Reviews SET rreply = '$rreply', eno = $eno WHERE rno = $rno";
    if (execute_query($updateQuery)) {
        header("Location: show_descr.php?dno=$dno&message=Reply+added+successfully");
        exit;
    } else {
        $message = "Error: Could not update the reply. Please try again.";
    }
}
?>

<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title><?php echo $row ? htmlspecialchars($row['dtitle']) : 'Item Description'; ?></title>
    <style>
        body { color: #fff; background-color: #0F1D4A; font-family: Arial, sans-serif; }
        .container { max-width: 800px; margin: 50px auto; padding: 20px; background-color: #223164; border-radius: 10px; }
        h1 { color: #946B2D; }
        .description-box { display: flex; flex-direction: column; align-items: center; }
        .image-box { width: 300px; height: 300px; margin-bottom: 20px; }
        .image-box img { width: 100%; height: 100%; object-fit: cover; border: 2px solid #5D5D5D; border-radius: 10px; }
        .description-text { color: #D6D6D6; }
        .description-text p { margin: 5px 0; }
        .btn { padding: 10px 10px; border: none; cursor: pointer; border-radius: 5px; font-size: 16px; }
        .btn-cart, .btn-buy, .btn-edit, .btn-reply, .btn-ask, .btn-review { background-color: #946B2D; color: #fff; }
        .btn:hover { opacity: 0.9; }
        .qna-section, .review-section { margin-top: 10px; border-radius: 10px; background-color: #223164; padding: 20px; }
        .qna-box, .review-box { background-color: #223164; padding: 20px; margin-bottom: 20px; }
        .qna-box h3, .review-box h3 { margin-top: 0; color: #946B2D; }
        .qna-table, .review-table { width: 100%; border-collapse: collapse; }
        .qna-table th, .qna-table td, .review-table th, .review-table td { border: 1px solid #946B2D; padding: 8px; text-align: left; }
        .qna-table th, .review-table th { background-color: #946B2D; color: #fff; }
    </style>
</head>
<body>
    <div class='container' data-usertype="<?php echo isset($_SESSION['usertype']) ? $_SESSION['usertype'] : 'Guest'; ?>">
        <?php if ($row) { ?>
            <h1><?php echo htmlspecialchars($row['dtitle']) ?></h1>
            <div class='description-box'>
                <div class='image-box'>
                    <img src='<?php echo htmlspecialchars($row['dimg']) ?>' alt='Image Missing'>
                </div>
                <div class='description-text'>
                    <p>Price: G<?php echo $row['iprice'] ?> Gallons</p>
                    <p>Description: <?php echo $row['dcont'] ?></p>
                </div>
            </div>
            <?php if ($isAvailableForSale) {
                if ($_SESSION['usertype'] == 'Guest' || $_SESSION['usertype'] == 'Customer' || !isset($_SESSION['usertype'])) { ?>
                    <button class='btn btn-cart' onclick='addToCart(<?php echo $row['dno'] ?>)'>Put it in the cart</button>
                    <button class='btn btn-buy' onclick='buyNow(<?php echo $row['dno'] ?>)'>Buy Now</button>
                <?php }
            } else { ?>
                <p style='color: #FF0000; font-weight: bold;'>This item is not available for now.</p>
            <?php }
            if (isset($_SESSION['usertype']) && $_SESSION['usertype'] == 'Employee') { ?>
                <button class='btn btn-edit' onclick='editItem(<?php echo $row['dno'] ?>)'>Edit</button>
            <?php }

            if ($message) { ?>
                <p class='message'><?php echo htmlspecialchars($message) ?></p>
            <?php }

            echo "<div class='qna-section'><h2>Q&A</h2>";
            if ($qnaResult->num_rows > 0) { ?>
                <table class='qna-table'>
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Content</th>
                            <th>Reply</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php while ($qna = $qnaResult->fetch_assoc()) { ?>
                            <tr>
                                <td><?php echo htmlspecialchars($qna['qtitle']) ?></td>
                                <td><?php echo htmlspecialchars($qna['qcont']) ?></td>
                                <td>
                                    <?php if ($_SESSION['usertype'] == 'Employee') { ?>
                                        <?php echo $qna['qreply'] ? htmlspecialchars($qna['qreply']) : "<form method='POST' action='show_descr.php?dno=$dno'>
                                            <input type='hidden' name='qno' value='" . $qna['qno'] . "'>
                                            <textarea name='qreply' required></textarea>
                                            <button type='submit' class='btn btn-reply'>Reply</button>
                                            </form>"; ?>
                                    <?php } else { 
                                        echo $qna['qreply'] ? htmlspecialchars($qna['qreply']) : 'No reply yet';
                                    } ?>
                                </td>
                            </tr>
                        <?php } ?>
                    </tbody>
                </table>
            <?php } else {
                echo "<p>No Q&A found for this item.</p>";
            }?>
            </br>
            <button class='btn btn-ask' onclick='askQuestion(<?php echo $row['dno'] ?>)'>Ask a Question</button>
            </div>

            <div class='review-section'><h2>Reviews</h2>
            <?php
            if ($reviewResult->num_rows > 0) { ?>
                <table class='review-table'>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Content</th>
                            <th>Image</th>
                            <th>Reply</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php while ($review = $reviewResult->fetch_assoc()) { ?>
                            <tr>
                                <td><?php echo htmlspecialchars($review['rtitle']) ?></td>
                                <td><?php echo htmlspecialchars($review['rcont']) ?></td>
                                <td>
                                    <?php if (!empty($review['rimg'])) { ?>
                                        <img width='100' src='/2assets/review/<?php echo htmlspecialchars($review['rimg']) ?>' alt='Review Image'>
                                    <?php } ?>
                                </td>
                                <td>
                                    <?php
                                    // Check if the user is an employee and if a reply hasn't been added yet
                                    if ($_SESSION['usertype'] == 'Employee' && empty($review['rreply'])) { ?>
                                        <form method='POST' action='show_descr.php?dno=<?php echo $dno ?>'>
                                            <input type='hidden' name='rno' value='<?php echo $review['rno'] ?>'>
                                            <textarea name='rreply' required></textarea>
                                            <button type='submit' class='btn btn-reply'>Reply</button>
                                        </form>
                                    <?php } else {
                                        echo $review['rreply'] ? htmlspecialchars($review['rreply']) : '';
                                    } ?>
                                </td>
                            </tr>
                        <?php } ?>
                    </tbody>
                </table>
            <?php } else {
                echo "<p>No reviews found for this item.</p>";
            }
            echo "</div>";

            // Add the "Write a Review" button for customers who have ordered this item
            if (isset($_SESSION['usertype']) && $_SESSION['usertype'] == 'Customer') {
                $checkOrderQuery = "SELECT Orders.* FROM Orders
                    INNER JOIN Users ON Orders.uno = Users.uno
                    WHERE Users.uid = '{$_SESSION['userid']}' AND Orders.ino = {$row['ino']}";

                $orderCheckResult = execute_query($checkOrderQuery);
                if ($orderCheckResult->num_rows > 0) {
                    echo "<button class='btn btn-review' onclick='leaveReview({$row['dno']})'>Write a Review</button>";
                }
            }

        } else {
            echo "<p>No description found for the given item.</p>";
        } ?>
        <br><br><br> If you need help with currency, please consult by:
        <a href="https://www.wizardingworld.com/fact-file/objects/wizardingmoney" style="color: #C0C0C0;">CLICKING HERE TO VISIT OFFICIAL GUIDE</a>
    </div>
    <script>
    function addToCart(dno)   { window.location.href = 'cart_action.php?dno=' + dno; }
    function buyNow(dno)      { window.location.href = 'buy_now_action.php?dno=' + dno; }
    function editItem(dno)    { window.location.href = '/1internals/admin/descr_edit.php?dno=' + dno; }
    function askQuestion(dno) {
        const userType = document.querySelector('.container').dataset.usertype;
        if (userType === 'Guest') {
            window.location.href = '/1internals/signin.php';
        } else {
            window.location.href = 'ask_question.php?dno=' + dno;
        }
    }
    function leaveReview(dno) { window.location.href = 'write_review.php?dno=' + dno; }
    </script>
</body>
</html>

