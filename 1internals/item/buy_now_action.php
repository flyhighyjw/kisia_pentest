<?php
require_once $_SERVER['DOCUMENT_ROOT'] . '/3severside/database.php';
session_start();

// Show me the money i mean error
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

$dno = isset($_GET['dno']) ? $_GET['dno'] : '';

// Check session user type and redirect accordingly
if (!isset($_GET['dno'])) { 
    header('Location: /errrrror.html'); // dno is not given. Also not supposed to happen.
    exit;
} elseif (!isset($_SESSION['usertype'])) { 
    header("Location: /1internals/signin.php?lastpage=buy&itemno=$dno"); // Session's not working or has been reset. Go back to Sign in.
    exit;
} elseif ($_SESSION['usertype'] == 'Employee') { 
    header('Location: /errrrror.html'); // Session is normal but it is an Employee. Not supposed to happen.
    exit;
} elseif ($_SESSION['usertype'] == 'Customer') { 
    buy_item($dno); // This is the main part.
} else { 
    header("Location: /1internals/signin.php?lastpage=buy&itemno=$dno"); // This means it is Guest. Or something else. Whatever. Go back to sign in.
    exit;
}

function buy_item($dno) {
    echo "
    <html>
        <body>
            <form id='buy_now_form' action='/1internals/item/check_out.php' method='POST'>
                <input type='hidden' name='dno_$dno' value='$dno'>
                <input type='hidden' name='amount_$dno' value='1'>
            </form>
            <script>
                document.getElementById('buy_now_form').submit();
            </script>
        </body>
    </html>
    ";
    exit;
}
?>
