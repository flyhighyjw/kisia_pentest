<?php
require_once $_SERVER['DOCUMENT_ROOT'].'/3severside/database.php';
session_start(); 

// Show errors
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// Check session
if (!isset($_SESSION['hasSignedIn']) || $_SESSION['usertype'] != 'Customer') {
    header("Location: /?target=signin");
    exit;
}

// Fetch uno from Users table using uid
$userid = $_SESSION['userid'];
$userResult = execute_query("SELECT uno FROM Users WHERE uid = '$userid'");
if ($userResult && $userResult->num_rows > 0) {
    $userRow = $userResult->fetch_assoc();
    $uno = $userRow['uno'];
} else {
    header("Location: /error.html");
    exit;
}

// Collect all dno and amount pairs from the POST request
$items = [];
$messages = ''; // Variable to store messages
foreach ($_POST as $key => $value) {
    if (strpos($key, 'dno_') === 0) {
        $dno = substr($key, 4); // Extract the dno value
        $amountKey = 'amount_' . $dno;
        if (isset($_POST[$amountKey])) {
            $amount = $_POST[$amountKey];
            if (is_numeric($amount) && $amount > 0) {
                // Fetch item details
                $itemResult = execute_query("SELECT iname, iprice, istock, istat FROM Items WHERE ino = (SELECT ino FROM Descriptions WHERE dno = '$dno')");
                if ($itemResult && $itemResult->num_rows > 0) {
                    $itemRow = $itemResult->fetch_assoc();
                    $itemName = $itemRow['iname'];
                    $itemPrice = $itemRow['iprice'];
                    $itemStock = $itemRow['istock'];
                    $itemStatus = $itemRow['istat'];

                    // If the item is not for sale, skip it
                    if (!$itemStatus || $itemStock == 0) {
                        $messages .= "<p>$itemName is not available for now. Soz.</p>";
                        continue;
                    }

                    // If the user's order amount exceeds stock, reduce it to stock level
                    if ($amount > $itemStock) {
                        $amount = $itemStock;
                        $messages .= "<p>Sorry, the amount for [$itemName] has been adjusted to the available stock: [$itemStock]</p>";
                    }

                    $items[$dno] = [
                        'name' => $itemName,
                        'amount' => $amount,
                        'price' => $itemPrice
                    ];
                }
            } else {
                echo "Invalid amount for dno $dno: $amount !!!!!!!!!!!!!!!!<br>";
                exit;
            }
        }
    }
}

// Check if there are valid items in the checkout form
if (empty($items)) {
    header("Location: /error.html");
    exit;
}

// Initialize total order price
$orderTotalPrice = 0;
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background-color: #222E4E; color: #FFFFFF; font-family: 'Arial', sans-serif; }
        .container { max-width: 800px; margin: 50px auto; padding: 20px; background-color: #0E162E; border-radius: 10px; }
        p { color: pink; }
        h1 { color: #1F5DB1; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #1F5DB1; }
        th { background-color: #1F5DB1; color: #FFFFFF; }
        .checkout-btn { background-color: #1F5DB1; color: #FFFFFF; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease; }
        .checkout-btn:hover { background-color: #0E4B92; }
        .action-btn { padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease; }
        .edit-btn { background-color: silver; color: black; }
        .remove-btn { background-color: #CD7F32; color: black; }
        .action-btn:hover { background-color: #555; }
        .add-shipping-btn { background-color: #1F5DB1; color: #FFFFFF; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease; display: inline-block; margin-top: 20px; }
        .add-shipping-btn:hover { background-color: #0E4B92; }
        tr:nth-child(even) { background-color: #2e3b70; }
        tr:nth-child(odd) { background-color: #1a2749; }
        tr:hover { background-color: #3c4b89; }
        #payment_method { width: 30%; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 5px; background-color: #1F5DB1; color: #FFFFFF; font-size: 16px; }
        #payment_method option { background-color: #1F5DB1; color: #FFFFFF; }
        #payment_info_input { width: 50%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background-color: #0c0c0c; color: #FFFFFF; font-size: 16px; margin-top: 20px; }
    </style>
    <script>
        function showPaymentField() {
            var paymentMethod = document.getElementById('payment_method').value;
            var paymentInfoLabel = document.getElementById('payment_info_label');
            var paymentInfoInput = document.getElementById('payment_info_input');

            if (paymentMethod ==='credit' || paymentMethod === 'debit') {
                paymentInfoLabel.textContent = 'Your Card Number';
            } else if (paymentMethod === 'apparition') {
                paymentInfoLabel.textContent = 'Location to apparate your money';
            } else if (paymentMethod === 'putontab') {
                paymentInfoLabel.textContent = 'Your magical social security number';
            } else if (paymentMethod === 'wire') {
                paymentInfoLabel.textContent = 'Sender Name of wire to Gringot';
            } else {
                paymentInfoLabel.textContent = 'Something wen wong';
            }

            paymentInfoInput.style.display = paymentMethod ? 'block' : 'none';
        }
    </script>
</head>
<body>
    <div class='container'>
        <h1>Order Summary</h1>
        
        <!-- Output messages here -->
        <?php if (!empty($messages)) echo $messages; ?>
        
        <table>
            <tr><th>Item Name</th><th>Amount of Order</th><th>Item Price</th><th>Total for this item</th></tr>
            <?php
            // Process each item in the cart
            foreach ($items as $dno => $item) {
                $itemName = $item['name'];
                $itemPrice = $item['price'];
                $amount = $item['amount'];
                $totalPrice = $itemPrice * $amount;

                // Accumulate order total price
                $orderTotalPrice += $totalPrice;

                echo "<tr>";
                echo "<td>$itemName</td>";
                echo "<td>$amount</td>";
                echo "<td>$itemPrice</td>";
                echo "<td>$totalPrice</td>";
                echo "</tr>";
            }
            ?>
            <tr>
                <td colspan='3' style='text-align:right;'><strong>Order Total Price:</strong></td>
                <td><?php echo $orderTotalPrice; ?></td>
                <input type="hidden" name="orderTotalPrice" value="<?php echo $orderTotalPrice; ?>">
            </tr>
        </table>

        <h2>Select Shipping Address</h2>
        <?php
        // Fetch shipping addresses linked to the user
        $shippingResult = execute_query("SELECT * FROM Shipinfo WHERE uno = '$uno'");
        if ($shippingResult && $shippingResult->num_rows > 0) {
            echo "<form method='POST' action='/1internals/item/complete_order.php'>";
            echo "<table border='1' cellpadding='5' cellspacing='0' style='width: 100%; margin: 0 auto;'>";
            echo "<tr><th>Select</th><th>Shipping Name</th><th>Receiver Name</th><th>Contact Number</th><th>Address</th><th>Note</th></tr>";
            while ($shippingRow = $shippingResult->fetch_assoc()) {
                $shno = $shippingRow['shno'];
                $shname = $shippingRow['shname'];
                $shreceiv = $shippingRow['shreceiv'];
                $shmono = $shippingRow['shmono'];
                $shaddr = $shippingRow['shaddr'];
                $shnote = $shippingRow['shnote'];
                echo "<tr>";
                echo "<td><input type='radio' name='shipping_address' value='{$shno}' required></td>";
                echo "<td>{$shname}</td>";
                echo "<td>{$shreceiv}</td>";
                echo "<td>{$shmono}</td>";
                echo "<td>{$shaddr}</td>";
                echo "<td>{$shnote}</td>";
                echo "</tr>";
            }
            echo "</table>";
        } else {
            echo "<p>No shipping addresses found. Please add a shipping address.</p>";
        }
        ?>

        <a href="/1internals/add_shipping.php" class="add-shipping-btn">Add Shipping Information</a>

        <?php if ($shippingResult && $shippingResult->num_rows > 0): ?>
            <h2>Select Payment Method</h2>
            <select id="payment_method" name="payment_method" onchange="showPaymentField()" required>
                <option value="">Select Payment Method</option>
                <?php
                $transResult = execute_query("SELECT transtypes FROM Transtypes");
                while ($transRow = $transResult->fetch_assoc()) {
                    $transType = $transRow['transtypes'];
                    echo "<option value='$transType'>$transType</option>";
                }
                ?>
            </select>

            <div id="payment_info_input" style="display:none; margin-top: 20px;">
                <label id="payment_info_label"></label><br>
                <input type="text" name="payment_info" required style="width: 90%;">
            </div>

            <?php
            // Add hidden inputs for items
            foreach ($items as $dno => $item) {
                echo "<input type='hidden' name='items[$dno][name]' value='{$item['name']}'>";
                echo "<input type='hidden' name='items[$dno][amount]' value='{$item['amount']}'>";
                echo "<input type='hidden' name='items[$dno][price]' value='{$item['price']}'>";
            }
            ?>
            
            <p><button type="submit" class="checkout-btn">Complete Order</button></p>
            </form>
        <?php endif; ?>
    </div>
</body>
</html>
<?php
exit;
?>
