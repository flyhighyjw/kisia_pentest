<?php
session_start();

// Check if user is logged in
if (!isset($_SESSION['userid'])) {
    require_once $_SERVER['DOCUMENT_ROOT'].'/3severside/resetSession.php';
    reset_session();
    header("Location: errrrror.html"); // Redirect to sign-in page if not logged in
    exit;
}

// Include necessary files
require_once $_SERVER['DOCUMENT_ROOT'] . '/3severside/database.php';

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    // Get form data
    $uname = $_POST['uname'];
    $uid = $_SESSION['userid'];
    $upw = $_POST['upw'];
    $upw_cfrm = $_POST['upw_cfrm'];
    $umail = $_POST['umail'];
    $umono = $_POST['umono'];

    // Validate input and perform necessary checks
    if (empty($uname) || empty($uid) || empty($upw) || empty($upw_cfrm) || empty($umail) || empty($umono)) {
        // Handle empty input fields
        $error_message = "All fields are required! >=(";
        header("Location: mypage.php?tab=info&error=" . urlencode($error_message));
        exit;
    } else if ($upw !== $upw_cfrm) {
        // Handle password mismatch
        $error_message = "Passwords do not match Brother!!";
        header("Location: mypage.php?tab=info&error=" . urlencode($error_message));
        exit;
    }
    
    // Check if email is already taken
    $result = execute_query("SELECT * FROM Users WHERE umail = '$umail'");
    if ($result->num_rows > 0) {
        $user = $result->fetch_assoc();
        if ($user['uid'] !== $uid) {
            // Email already exists and belongs to another user
            $error_message = "Email address is already taken!";
            header("Location: mypage.php?tab=info&error=" . urlencode($error_message));
            exit;
        }
    }
    
    // Check if phone number is already taken
    $result = execute_query("SELECT * FROM Users WHERE umono = '$umono'");
    if ($result->num_rows > 0) {
        $user = $result->fetch_assoc();
        if ($user['uid'] !== $uid) {
            // Phone number already exists and belongs to another user
            $error_message = "Phone number is already taken!";
            header("Location: mypage.php?tab=info&error=" . urlencode($error_message));
            exit;
        }
    }
    
    // Fetch user details from the database
    $userid = $_SESSION['userid'];
    $result = execute_query("SELECT * FROM Users WHERE uid = '$userid'");

    if ($result->num_rows > 0) {
        $user = $result->fetch_assoc();
        $uno = $user['uno']; // Assuming 'uno' is the primary key of the Users table

        // Update user information in the database
        $sql = "UPDATE Users SET uname='$uname', uid='$uid', upw='$upw', umail='$umail', umono='$umono' WHERE uno=$uno";
        $result = execute_query($sql);

        // Redirect to mypage.php after successful update with success message
        $success_message = "Information updated successfully!";
        header("Location: mypage.php?tab=info&success=" . urlencode($success_message));
        exit;        
    } else {
        // Handle if user not found
        $error_message = "User not found.";
        header("Location: mypage.php?tab=info&error=" . urlencode($error_message));
        exit;
    }
        
}
?>
