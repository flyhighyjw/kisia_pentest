<?php
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// Destroy any session if exists, just to be sure.
require $_SERVER['DOCUMENT_ROOT'].'/3severside/resetSession.php';
session_start();
reset_session();

require $_SERVER['DOCUMENT_ROOT'].'/3severside/database.php';

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    // Retrieve form data
    $uid = $_POST['id'];
    $upw = $_POST['passwd'];
    $uname = $_POST['name'];
    $umail = $_POST['mail'];
    $umono = $_POST['tel'];

    // Perform validation
    if (empty($uid) || empty($upw) || empty($uname) || empty($umail) || empty($umono)) {
        // Handle empty fields
        header("Location: signup.php?error=All fields are required!");
        exit;
    } elseif ($upw !== $_POST['pwcheck']) {
        // Handle password mismatch
        header("Location: signup.php?error=Passwords do not match!");
        exit;
    }

    // Check if the email is already registered
    $sql = "SELECT * FROM Users WHERE umail='$umail'";
    $result = execute_query($sql);
    if (!$result) {
        // Handle database error
        header("Location: signup.php?error=Database error!");
        exit;
    }

    if (mysqli_num_rows($result) > 0) {
        // Email already exists
        header("Location: signup.php?error=Email already registered!");
        exit;
    }

    // Check if the username is already registered
    $sql = "SELECT * FROM Users WHERE uid='$uid'";
    $result = execute_query($sql);
    if (!$result) {
        // Handle database error
        header("Location: signup.php?error=Database error!");
        exit;
    }

    if (mysqli_num_rows($result) > 0) {
        // Username already exists
        header("Location: signup.php?error=Username already registered!");
        exit;
    }

    // Check if the phone number is already registered
    if ($umono <= 4294967295) { // Maximum value for unsigned int
        $sql = "SELECT * FROM Users WHERE umono='$umono'";
        $result = execute_query($sql);
        if (!$result) {
            // Handle database error
            header("Location: signup.php?error=Database error!");
            exit;
        }
        if (mysqli_num_rows($result) > 0) {
            // Phone number already exists
            header("Location: signup.php?error=Phone number already registered!");
            exit;
        }
    } else {
        // Handle umono value exceeding the maximum range
        header("Location: signup.php?error=Phone number exceeds maximum range!");
        exit;
    }

    // Insert user into the database
    $sql = "INSERT INTO Users (uid, upw, uname, umail, umono) VALUES ('$uid', '$upw', '$uname', '$umail', '$umono')";
    $result = execute_query($sql);
    if ($result) {
        // User registered successfully, create session
        $_SESSION["userid"]   = $uid;
        $_SESSION["username"] = $uname;
        $_SESSION["usertype"] = "Customer"; 
        $_SESSION["hasSignedIn"] = true; 

        // Redirect to index.php in parent window
        echo "<script>window.parent.location.href = '/'</script>";
        exit;
    } else {
        // Error in registration
        header("Location: signup.php?error=Registration failed!");
        exit;
    }

} else {
    // If the request method is not POST, redirect to the signup page
    header("Location: signup.php");
    exit;
}
?>
