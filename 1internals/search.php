<?php 
require_once $_SERVER['DOCUMENT_ROOT'].'/3severside/database.php';
error_reporting(E_ALL);
ini_set('display_errors', 1);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { color: white; background-color: #0e1a40; }
        .description-box { border: 1px solid white; padding: 10px; margin-bottom: 20px; display: flex; align-items: center; }
        .description-text { flex: 1; margin-right: 20px; }
        .description-title { font-weight: bold; color: white; text-decoration: none; }
        .description-title:hover { text-decoration: underline; }
        .description-price { color: white; }
        .image-box { width: 100px; height: 100px; margin-right: 20px; }
        .image-box img { width: 100%; height: 100%; object-fit: cover; }
        .pagination { margin-top: 20px; }
        .pagination a { color: white; padding: 5px 10px; text-decoration: none; border: 1px solid white; margin-right: 5px; }
        .pagination a.active { background-color: white; color: black; }
    </style>
</head>
<body>
    <?php
    $heading = "Search Results for ";
    if (isset($_GET['search'])) {
        $heading .= $_GET['search'];
    } elseif (isset($_GET['category'])) {
        $heading .= $_GET['category'];
    }
    ?>
    
    <h1><?php echo $heading ?></h1>

    <?php
    $resultsPerPage = 6;
    if (isset($_GET['search'])) 
    {
        $searchQuery = $_GET['search'];
        $countQuery = "SELECT COUNT(*) as total FROM Descriptions 
                       WHERE dtitle LIKE '%$searchQuery%' OR dcont LIKE '%$searchQuery%'";
        $countResult = execute_query($countQuery);
        $totalResults = $countResult->fetch_assoc()['total'];
        $totalPages = ceil($totalResults / $resultsPerPage);
        $currentPage = isset($_GET['page']) ? $_GET['page'] : 1;
        $offset = ($currentPage - 1) * $resultsPerPage;

        $query = "SELECT D.dno, D.dtitle, I.iprice, D.dimg , D.dcont
                  FROM Descriptions AS D 
                  INNER JOIN Items AS I ON D.ino = I.ino 
                  WHERE D.dtitle LIKE '%$searchQuery%' OR D.dcont LIKE '%$searchQuery%'
                  LIMIT $offset, $resultsPerPage";
        $result = execute_query($query);
        if ($result->num_rows > 0) {
            while ($row = $result->fetch_assoc()) 
            { ?>
                <div class='description-box'>
                    <a href='item/show_descr.php?dno=<?php echo $row['dno'] ?>'>
                        <div class='image-box'><img src='<?php echo $row['dimg'] ?>' alt='<X_X> Image Missing'></div>
                    </a>
                    <div class='description-text'>
                        <a href='item/show_descr.php?dno=<?php echo $row['dno'] ?>' class='description-title'><?php echo $row['dtitle'] ?></a>
                        <p class='description-price'>Price: ʛ<?php echo $row['iprice'] ?> (Gallons)</p>
                        <p class='description-price'>Description: <?php echo $row['dcont'] ?></p>
                    </div>
                </div>
            <?php 
            }
            ?>
            <div class='pagination'>
            <?php
            if ($currentPage > 1) 
            {
                 echo "<a href='?search=$searchQuery&page=" . ($currentPage - 1) . "'>&laquo; Previous</a>"; 
            }
            for ($i = 1; $i <= $totalPages; $i++) 
            { 
                echo "<a href='?search=$searchQuery&page=$i' " . ($currentPage == $i ? "class='active'" : "") . ">$i</a>"; 
            }
            if ($currentPage < $totalPages) 
            { 
                echo "<a href='?search=$searchQuery&page=" . ($currentPage + 1) . "'>Next &raquo;</a>"; 
            }
            ?>
            </div> 
            <?php
        } else { ?> <p>No descriptions found.</p> <?php }
    } 
    elseif (isset($_GET['category'])) 
    {
        $category = $_GET['category'];
        $countQuery = "SELECT COUNT(*) as total FROM Descriptions AS D
                       INNER JOIN Items AS I ON D.ino = I.ino
                       WHERE I.icat LIKE '%$category%'";
        $countResult = execute_query($countQuery);
        $totalResults = $countResult->fetch_assoc()['total'];
        $totalPages = ceil($totalResults / $resultsPerPage);
        $currentPage = isset($_GET['page']) ? $_GET['page'] : 1;
        $offset = ($currentPage - 1) * $resultsPerPage;

        $query = "SELECT D.dno, D.dtitle, I.iprice, D.dimg, D.dcont
                  FROM Descriptions AS D 
                  INNER JOIN Items AS I ON D.ino = I.ino 
                  WHERE I.icat LIKE '%$category%'
                  LIMIT $offset, $resultsPerPage";
        $result = execute_query($query);
        if ($result->num_rows > 0) 
        {
            while ($row = $result->fetch_assoc()) 
            { ?>
                <div class='description-box'>
                    <div class='image-box'><img src='<?php echo $row['dimg'] ?>' alt='<X_X> Image Missing'></div>
                    <div class='description-text'>
                        <a href='item/show_descr.php?dno=<?php echo $row['dno'] ?>' class='description-title'><?php echo $row['dtitle'] ?></a>
                        <p class='description-price'>Price: ʛ<?php echo $row['iprice'] ?> (Gallons)</p>
                        <p class='description-price'>Description: <?php echo $row['dcont'] ?></p>
                    </div>
                </div>
                <?php 
            } ?>
            
            <div class='pagination'> 
            
            <?php
            if ($currentPage > 1) 
            { 
                echo "<a href='?category=$category&page=" . ($currentPage - 1) . "'>&laquo; Previous</a>"; 
            }
            for ($i = 1; $i <= $totalPages; $i++) 
            { 
                echo "<a href='?category=$category&page=$i' " . ($currentPage == $i ? "class='active'" : "") . ">$i</a>"; 
            }
            if ($currentPage < $totalPages) 
            { 
                echo "<a href='?category=$category&page=" . ($currentPage + 1) . "'>Next &raquo;</a>"; 
            }
            echo "</div>";
        } else { ?><p>No descriptions found for the category.</p><?php }
    } else { ?><p>No search query provided.</p><?php }
    ?>

    <br> If you need help with currency, please consult by:
    <a href="javascript:void(0);" onclick="redirectToParentURL('https://www.wizardingworld.com/fact-file/objects/wizarding-money')" style="color: #C0C0C0;">
        CLICKING HERE TO VISIT THE OFFICIAL GUIDE
    </a>

    <script> 
        function redirectToParentURL(url) 
        { 
            window.parent.parent.location.href = url; 
        } 
    </script>
</body>
</html>

