<?php
session_start();

// Check if user is logged in
if (!isset($_SESSION['userid'])) {
    require_once $_SERVER['DOCUMENT_ROOT'].'/3severside/resetSession.php';
    reset_session();
    header("Location: /errrrror.html"); // Redirect to sign-in page if not logged in
    exit;
}

// Include necessary files
require_once $_SERVER['DOCUMENT_ROOT'] . '/3severside/database.php';

// Function to sanitize and display messages
function sanitize_message($message) {
    return htmlspecialchars($message, ENT_QUOTES);
}

// Fetch user details from the database
$userid = $_SESSION['userid'];
$sql = "SELECT * FROM Users WHERE uid = '$userid'";
$result = execute_query($sql);

if ($result->num_rows > 0) {
    $user = $result->fetch_assoc();
}

// Fetch user's order data from the database
$result = execute_query("SELECT Orders.*, Items.iname, Shipinfo.shname, Descriptions.dno FROM Orders
                        LEFT JOIN Items ON Orders.ino = Items.ino
                        LEFT JOIN Shipinfo ON Orders.shno = Shipinfo.shno
                        LEFT JOIN Descriptions ON Orders.ino = Descriptions.ino
                        WHERE Orders.uno = {$user['uno']}");
$orders = [];
if ($result->num_rows > 0) {
    while ($row = $result->fetch_assoc()) {
        $orders[] = $row;
    }
}



// Fetch user's shipping information from the database
$result = execute_query("SELECT * FROM Shipinfo WHERE uno = {$user['uno']}");
$shipinfo = [];
if ($result->num_rows > 0) {
    while ($row = $result->fetch_assoc()) {
        $shipinfo[] = $row;
    }
} else {
    $shipinfo = null;
}

// Check which button is clicked
$currentTab = isset($_GET['tab']) ? $_GET['tab'] : 'info';

// Check for error or success messages
$error_message = isset($_GET['error']) ? sanitize_message($_GET['error']) : null;
$success_message = isset($_GET['success']) ? sanitize_message($_GET['success']) : null;
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; background-color: #222f5b; color: #ffffff; margin: 0; padding: 0; display: flex; }
        .sidebar { width: 200px; background-color: #0e1a40; padding: 20px; }
        .main-content { flex: 1; padding: 20px; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; background-color: #0e1a40; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        h1, h2 { text-align: center; color: #222f5b; }
        form { margin-top: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #ffffff; }
        input[type="text"], input[type="email"] { width: 100%; height: 40px; font-size: 16px; padding: 8px; border: 1px solid #5579a1; border-radius: 4px; box-sizing: border-box; background-color: #f0f5f9; color: #333; }
        input[type="submit"] { width: 100%; height: 40px; font-size: 16px; font-weight: bold; color: #ffffff; background-color: #a7845d; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px; }
        input[type="submit"]:hover { background-color: #725829; }
        .btn-group { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .btn-group button { width: 32%; height: 50px; font-size: 16px; font-weight: bold; color: #ffffff; background-color: #5579a1; border: none; border-radius: 4px; cursor: pointer; }
        .btn-group button:hover { background-color: #335279; }
        .action-buttons { display: flex; justify-content: space-between; margin-top: 10px; }
        .action-buttons button { width: 48%; height: 40px; font-size: 16px; font-weight: bold; color: #ffffff; background-color: #5579a1; border: none; border-radius: 4px; cursor: pointer; }
        .action-buttons button:hover { background-color: #335279; }
        .shipping-info { margin-bottom: 20px; padding: 10px; background-color: #0e1a40; border: 1px solid #5579a1; border-radius: 4px; }
        input[type="password"] { width: 100%; height: 40px; font-size: 16px; padding: 8px; border: 1px solid #5579a1; border-radius: 4px; box-sizing: border-box; background-color: #f0f5f9; color: #333; }
        input[readonly] { color: #333; background-color: #e0e0e0; border-color: #ccc; cursor: not-allowed; }
        .order-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .order-table th, .order-table td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }

        .order-table th {
            background-color: #0e1a40;
            color: #ffffff;
        }

        .order-table tbody tr:hover {
            background-color: #2c3e78;
        }

        .order-table tbody tr.even {
            background-color: #1e2d5e;
        }

        .order-table tbody tr.odd {
            background-color: #0e1a40;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="btn-group">
            <button onclick="changeTab('info')">Your Info</button>
            <button onclick="changeTab('shipping')">Shipping Info</button>
            <button onclick="changeTab('orders')">Order History</button>
        </div>
        <h2>Your Information</h2>
        <p><strong>ID:</strong> <?php echo $user['uid']; ?></p>
        <p><strong>Name:</strong> <?php echo $user['uname']; ?></p>
        <p><strong>Email:</strong> <?php echo $user['umail']; ?></p>
        <p><strong>Phone:</strong> <?php echo $user['umono']; ?></p>
    </div>
    <div class="main-content">
    <?php
        if ($error_message){
            echo '<div class="container"><p style="color: red;"  >' . $error_message   .'</p></div>';
        } elseif ($success_message){
            echo '<div class="container"><p style="color: green;">' . $success_message .'</p></div>';
        }?>
        <?php if ($currentTab === 'info') : ?>
            <div class="container">
                <h1>Edit Your Info</h1>
                * All given forms are required to be filled.
                <form method="post" action="update_customer_info.php">
                    <label for="name">Name:</label>
                    <input type="text" name="uname" value="<?php echo $user['uname']; ?>"><br>
                    <label for="name">ID: (Sorry, you can't change your id)</label>
                    <input type="text" name="uid" value="<?php echo $user['uid']; ?>" readonly><br>
                    <label for="name">Password:</label>
                    <input type="password" name="upw" value=""><br>
                    <label for="name">Confirm your Password:</label>
                    <input type="password" name="upw_cfrm" value=""><br>
                    <label for="email">Email:</label>
                    <input type="email" name="umail" value="<?php echo $user['umail']; ?>"><br>
                    <label for="phone">Phone:</label>
                    <input type="text" name="umono" value="<?php echo $user['umono']; ?>"><br>
                    <input type="submit" name="update" value="Update Information">
                </form>
            </div>
        <?php elseif ($currentTab === 'shipping') : ?>
        <div class="container">
            <h1>Shipping Information</h1>
            <?php if ($shipinfo) : ?>
                <?php foreach ($shipinfo as $info) : ?>
                    <div class="shipping-info">
                        <p><strong>Name:</strong> <?php echo $info['shname']; ?></p>
                        <p><strong>Recipient:</strong> <?php echo $info['shreceiv']; ?></p>
                        <p><strong>Contact #:</strong> <?php echo $info['shmono']; ?></p>
                        <p><strong>Address:</strong> <?php echo $info['shaddr']; ?></p>
                        <p><strong>Note:</strong> <?php echo $info['shnote']; ?></p>
                        <div class="action-buttons">
                            <button onclick="location.href='add_shipping.php?id=<?php echo $info['shno']; ?>'">Edit</button>
                        </div>
                    </div>
                <?php endforeach; ?>
                <div class="action-buttons">
                    <button onclick="location.href='add_shipping.php'">Add Shipping Information</button>
                </div>
            <?php else : ?>
                <p>No shipping information available.</p>
                <div class="action-buttons">
                    <button onclick="location.href='add_shipping.php'">Add Shipping Information</button>
                </div>
            <?php endif; ?>
        </div>
        <?php elseif ($currentTab === 'orders') : ?>
        <div class="container">
            <h1>Order History</h1>
            <?php if ($orders) : ?>
                <div class="order-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Shipping Info Name</th>
                                <th>Amount of Item</th>
                                <th>Order Date</th>
                                <th>Order state</th>
                            </tr>
                        </thead>
                        <tbody>
                        <?php foreach ($orders as $index => $order) : ?>
                            <tr class="<?php echo $index % 2 === 0 ? 'even' : 'odd'; ?>">
                                <td><a href="item/show_descr.php?dno=<?php echo $order['dno']; ?>" style="color: white; text-decoration: none;"><?php echo $order['iname']; ?></a></td>
                                <td><?php echo $order['shname']; ?></td>
                                <td><?php echo $order['oamo']; ?></td>
                                <td><?php echo $order['odate']; ?></td>
                                <td><?php echo $order['ostat']; ?></td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            <?php else : ?>
                <p>No order history available.</p>
            <?php endif; ?>
        </div>
        <?php endif; ?>

    <script>
        function changeTab(tab) {
            window.location.href = "mypage.php?tab=" + tab;
        }
    </script>
</body>
</html>
