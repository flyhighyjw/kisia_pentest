<?php
require_once $_SERVER['DOCUMENT_ROOT'] . '/3severside/database.php';
session_start();

// Show me the money i mean error
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="description" content="Greetings toward the potential red team leaders!" />
    <meta charset="utf-8">
    <title>O-no mall</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/0style/mainw3.css">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f8ff; color: #000; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        form { background-color: #fff; border: 2px solid #2a52be; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); padding: 20px; max-width: 500px; width: 100%; }
        form label { display: block; margin-bottom: 4px; font-weight: bold; color: #2a52be; }
        form input[type="text"], form input[type="number"], form textarea { width: calc(100% - 20px); padding: 5px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        form input[type="submit"] { background-color: #2a52be; color: #fff; border: none; border-radius: 5px; padding: 10px 20px; font-size: 16px; cursor: pointer; transition: background-color 0.3s ease; }
        form input[type="submit"]:hover { background-color: #1e3d8f; }
        form textarea { height: 150px; resize: none; }
    </style>
</head>
<body>
    <?php
    $dno = isset($_GET['dno']) ? $_GET['dno'] : '';
    $ino = isset($_GET['ino']) ? $_GET['ino'] : '';

    // Check session user type and redirect accordingly
    if (!isset($_GET['dno']) && !isset($_GET['ino'])) { header('Location: /errrrror.html'); exit(); }                            // dno is not given. Also not supposed to happen.
    elseif (!isset($_SESSION['usertype'])) { header("Location: /1internals/signin.php?lastpage=buy&itemno=$dno"); exit(); }      // Session's not working or has been reset. Go back to Sign in.
    elseif ($_SESSION['usertype'] == 'Customer') { header('Location: /error.html'); exit(); }                                    // Session is normal but it is a Customer. Not supposed to happen.
    elseif ($_SESSION['usertype'] != 'Employee') { header("Location: /1internals/signin.php?lastpage=buy&itemno=$dno"); exit(); }// This means it is Guest. Or something else. Whatever. Go back to sign in.
    
    if(isset($_GET['dno']))
    {
        $result = execute_query("SELECT dtitle, dcont, dimg, ino FROM Descriptions WHERE dno = '$dno'");
        if (!$result) { echo "Query failed: " . execute_query_error() . "<br>"; exit(); }
        elseif ($result->num_rows <= 0) { echo "Item not found. Invalid dno.<br>"; exit(); }
        $row    = $result->fetch_assoc();
        $dtitle = $row['dtitle'];
        $dcont  = $row['dcont'];
        $dimg   = $row['dimg'];
        $ino    = $row['ino'];

        $item_result = execute_query("SELECT iname, icat, istock, iprice, istat FROM Items WHERE ino = '$ino'");
        if (!$item_result) { echo "Item query failed: " . execute_query_error() . "<br>"; exit(); }
        elseif ($item_result->num_rows <= 0) { echo "Item not found. Invalid ino.<br>"; exit(); }
        $item_row = $item_result->fetch_assoc();
        $iname  = $item_row['iname'];
        $icat   = $item_row['icat'];
        $istock = $item_row['istock'];
        $iprice = $item_row['iprice'];
        $istat  = $item_row['istat'];
    } 
    else if (isset($_GET['ino']))
    {
        $item_result = execute_query("SELECT iname, icat, istock, iprice, istat FROM Items WHERE ino = '$ino'");
        if (!$item_result) { echo "Item query failed: " . execute_query_error() . "<br>"; exit(); }
        elseif ($item_result->num_rows <= 0) { echo "Item not found. Invalid ino.<br>"; exit(); }
        $item_row = $item_result->fetch_assoc();
        $iname  = $item_row['iname'];
        $icat   = $item_row['icat'];
        $istock = $item_row['istock'];
        $iprice = $item_row['iprice'];
        $istat  = $item_row['istat'];

        $result = execute_query("SELECT dtitle, dcont, dimg, dno FROM Descriptions WHERE ino = '$ino'");
        if (!$result) { echo "Query failed: " . execute_query_error() . "<br>"; exit(); }
        elseif ($result->num_rows <= 0) { echo "Item not found. Invalid dno.<br>"; exit(); }
        $row    = $result->fetch_assoc();
        $dtitle = $row['dtitle'];
        $dcont  = $row['dcont'];
        $dimg   = $row['dimg'];
        $dno    = $row['dno'];
    } 
    else 
    { 
        header('Location: /errrrror.html');
        exit();
    }
    
    // Display the form for editing the description and item details
    if ($_SERVER['REQUEST_METHOD'] == 'POST') {
        // Handle the form submission
        $new_dtitle = $_POST['dtitle'];
        $new_dcont  = $_POST['dcont'];
        $new_dimg   = $_POST['dimg'];
        $new_iname  = $_POST['iname'];
        $new_icat   = $_POST['icat'];
        $new_istock = $_POST['istock'];
        $new_iprice = $_POST['iprice'];
        $new_istat  = $_POST['istat'];

        // Upload new image file if provided
        if ($_FILES['file']['name']) {
            $new_dimg = uploadFile($_FILES['file']);
        }

        // Update Descriptions table
        $update_query = "UPDATE Descriptions SET dtitle = '$new_dtitle', dcont = '$new_dcont', dimg = '$new_dimg' WHERE dno = '$dno'";
        //echo "Executing update query: $update_query<br>";
        $update_result = execute_query($update_query);

        // Update Items table
        $update_item_query = "UPDATE Items SET iname = '$new_iname', icat = '$new_icat', istock = '$new_istock', iprice = '$new_iprice', istat = '$new_istat' WHERE ino = '$ino'";
        //echo "Executing update item query: $update_item_query<br>";
        $update_item_result = execute_query($update_item_query);

        if (!$update_result || !$update_item_result) {
            //echo "Update failed: " . execute_query_error() . "<br>";
        } else {
            //echo "Description and item details updated successfully.<br>";
            if (isset($_GET['dno'])){
                header("Location: /1internals/item/show_descr.php?dno=$dno&message=Description%20and%20item%20details%20updated%20successfully");
            }
            elseif (isset($_GET['ino'])){
                header("Location: /1internals/admin/item_management.php?ino=$ino&message=Description%20and%20item%20details%20updated%20successfully");
                }
            exit();
        }
    } else {
        // Display the form with Ravenclaw-themed styling
        ?>
        <form method="POST" action="" enctype="multipart/form-data">
            <label for="dtitle">Edit Description Title:</label><br>
            <input type="text" id="dtitle" name="dtitle" value="<?php echo htmlspecialchars($dtitle); ?>"><br><br>
            <label for="dcont">Edit Description Content:</label><br>
            <textarea id="dcont" name="dcont" rows="4" cols="50"><?php echo htmlspecialchars($dcont); ?></textarea><br><br>
            <label for="dimg">Edit Image URL:</label><br>
            <input type="text" id="dimg" name="dimg" value="<?php echo htmlspecialchars($dimg); ?>"><br><br>
            <label for="file">Upload New Image:</label><br>
            <input type="file" id="file" name="file"><br><br>

            <label for="iname">Edit Item Name:</label><br>
            <input type="text" id="iname" name="iname" value="<?php echo htmlspecialchars($iname); ?>"><br><br>
            <label for="icat">Edit Item Category:</label><br>
            <input type="text" id="icat" name="icat" value="<?php echo htmlspecialchars($icat); ?>"><br><br>
            <label for="istock">Edit Item Stock:</label><br>
            <input type="number" id="istock" name="istock" value="<?php echo htmlspecialchars($istock); ?>"><br><br>
            <label for="iprice">Edit Item Price:</label><br>
            <input type="number" id="iprice" name="iprice" value="<?php echo htmlspecialchars($iprice); ?>"><br><br>
            <label for="istat">Edit Item Status (0 = Not for Sale | 1 = On shelf):</label><br>
            <input type="number" id="istat" name="istat" value="<?php echo htmlspecialchars($istat); ?>"><br><br>

            <input type="submit" value="Update">
        </form>
        <?php
    }
    ?>
</body>
</html>

<?php
function uploadFile($file)
{
    $targetDir = "/2assets/item/"; // Directory where you want to save the uploaded image
    $targetFile = $targetDir . basename($file["name"]);
    $uploadOk = 1;
    $imageFileType = strtolower(pathinfo($targetFile, PATHINFO_EXTENSION));

    // Check if image file is a actual image or fake image
    $check = getimagesize($file["tmp_name"]);
    if ($check !== false) {
        echo "File is an image - " . $check["mime"] . ".";
        $uploadOk = 1;
    } else {
        echo "File is not an image.";
        $uploadOk = 0;
    }

    // Check file size
    if ($file["size"] > 500000) {
        echo "Sorry, your file is too large.";
        $uploadOk = 0;
    }

    // Allow certain file formats
    if ($imageFileType != "jpg" && $imageFileType != "png" && $imageFileType != "jpeg"
        && $imageFileType != "gif") {
        echo "Sorry, only JPG, JPEG, PNG & GIF files are allowed.";
        $uploadOk = 0;
    }

    // Check if $uploadOk is set to 0 by an error
    if ($uploadOk == 0) {
        echo "Sorry, your file was not uploaded.";
    // if everything is ok, try to upload file
    } else {
        if (move_uploaded_file($file["tmp_name"], $targetFile)) {
            echo "The file ". htmlspecialchars(basename($file["name"])). " has been uploaded.";
            return $targetFile;
        } else {
            echo "Sorry, there was an error uploading your file.";
        }
    }
    return null;
}
?>

